<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz esercitazione</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 20px; line-height: 1.35; }
    .top { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { padding:10px 14px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; }
    button:hover { background:#f6f6f6; }
    .pill { padding:6px 10px; border:1px solid #ddd; border-radius:999px; }
    .q { border:1px solid #e6e6e6; border-radius:14px; padding:14px; margin:12px 0; }
    .q h3 { margin:0 0 10px; font-size:16px; }
    .opt { display:block; padding:8px 10px; border:1px solid #eee; border-radius:12px; margin:6px 0; cursor:pointer; }
    .opt input { margin-right:10px; }
    .correct { border-color: #bfe6c6; background: #f2fbf4; }
    .wrong { border-color: #f2b8b5; background: #fff3f3; }
    .muted { color:#666; font-size: 13px; }
    .sticky { position:sticky; top:10px; background:rgba(255,255,255,.92); backdrop-filter: blur(8px); padding:10px; border:1px solid #eee; border-radius:14px; margin-bottom:12px; }
  </style>
</head>
<body>
  <div class="sticky top">
    <button id="new">Nuovo quiz (random)</button>
    <button id="grade">Correggi</button>
    <span class="pill" id="status">Caricamento...</span>
    <span class="muted">Le opzioni vengono rimescolate: la corretta non è sempre “A”.</span>
  </div>

  <div id="quiz"></div>

  <script>
    let QUESTIONS = [];
    let RENDERED = []; // {id, correctIndex, options:[{label,text,isCorrect}], chosenIndex}

    function shuffle(arr){
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function esc(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function load(){
      const res = await fetch('./questions.json', { cache: 'no-store' });
      QUESTIONS = await res.json();
    }

    function render(){
      const quizEl = document.getElementById('quiz');
      quizEl.innerHTML = '';
      RENDERED = [];

      const qs = shuffle([...QUESTIONS]); // domande random

      qs.forEach((q, idx) => {
        // nel tuo file la corretta è sempre la A: quindi options.A è corretta
        const opts = [
          { key:'A', text:q.options.A, isCorrect:true },
          { key:'B', text:q.options.B, isCorrect:false },
          { key:'C', text:q.options.C, isCorrect:false },
          { key:'D', text:q.options.D, isCorrect:false },
        ];

        shuffle(opts); // opzioni random
        const correctIndex = opts.findIndex(o => o.isCorrect);

        const labels = ['A','B','C','D'];
        const mapped = opts.map((o, i) => ({ label: labels[i], text: o.text, isCorrect: o.isCorrect }));

        const card = document.createElement('div');
        card.className = 'q';
        card.dataset.qid = q.id;

        card.innerHTML = `
          <h3>${idx+1}. ${esc(q.question)}</h3>
          <div class="opts">
            ${mapped.map((o, i) => `
              <label class="opt" data-idx="${i}">
                <input type="radio" name="q_${q.id}" value="${i}">
                <strong>${o.label})</strong> ${esc(o.text)}
              </label>
            `).join('')}
          </div>
          <div class="muted" style="margin-top:8px;"></div>
        `;

        // store
        RENDERED.push({ id:q.id, correctIndex, options:mapped, chosenIndex:null });

        // handlers
        card.querySelectorAll('input[type="radio"]').forEach(inp => {
          inp.addEventListener('change', (e) => {
            const chosen = Number(e.target.value);
            const r = RENDERED.find(x => x.id === q.id);
            r.chosenIndex = chosen;
          });
        });

        quizEl.appendChild(card);
      });

      document.getElementById('status').textContent = `Domande: ${QUESTIONS.length}`;
    }

    function grade(){
      let correct = 0;

      RENDERED.forEach(r => {
        const card = document.querySelector(`.q[data-qid="${r.id}"]`);
        const optLabels = card.querySelectorAll('.opt');

        // reset styles
        optLabels.forEach(l => l.classList.remove('correct','wrong'));

        // mark correct
        if (r.correctIndex >= 0) optLabels[r.correctIndex].classList.add('correct');

        // mark wrong chosen
        if (r.chosenIndex != null && r.chosenIndex !== r.correctIndex) {
          optLabels[r.chosenIndex].classList.add('wrong');
        }

        if (r.chosenIndex === r.correctIndex) correct++;
        const info = card.querySelector('.muted');
        info.textContent = (r.chosenIndex == null)
          ? 'Non hai risposto.'
          : (r.chosenIndex === r.correctIndex ? '✅ Corretta' : '❌ Sbagliata');
      });

      document.getElementById('status').textContent = `Punteggio: ${correct}/${RENDERED.length}`;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('new').addEventListener('click', render);
    document.getElementById('grade').addEventListener('click', grade);

    (async () => {
      try {
        await load();
        render();
      } catch (e) {
        document.getElementById('status').textContent = 'Errore: non trovo questions.json';
        console.error(e);
      }
    })();
  </script>
</body>
</html>
