<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moodle SCM ‚Äì Tecniche Investigative</title>
  <meta name="description" content="Quiz Tecniche Investigative: interfaccia premium, feedback immediato, random, timer, segnalibri, ricerca, salvataggio." />

  <style>
    :root{
      --bg0:#0b0c10;
      --bg1:#0f1220;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.45);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.25);
      --radius: 22px;
      --radius2: 16px;
      --accent: #ffffff;
      --ok: #45d483;
      --bad: #ff6b6b;
      --warn: #ffd166;
      --maxw: 1180px;

      --ringBg: rgba(255,255,255,.10);
    }

    /* Light mode (optional, still pretty) */
    [data-theme="light"]{
      --bg0:#f6f7fb;
      --bg1:#ffffff;
      --card: rgba(0,0,0,.03);
      --card2: rgba(0,0,0,.02);
      --stroke: rgba(0,0,0,.08);
      --stroke2: rgba(0,0,0,.06);
      --text: rgba(0,0,0,.88);
      --muted: rgba(0,0,0,.60);
      --muted2: rgba(0,0,0,.45);
      --shadow: 0 18px 60px rgba(0,0,0,.10);
      --shadow2: 0 10px 30px rgba(0,0,0,.08);
      --accent:#111;
      --ringBg: rgba(0,0,0,.06);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      line-height: 1.35;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(0,214,255,.25), transparent 50%),
        radial-gradient(900px 700px at 70% 90%, rgba(255,209,102,.15), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: 18px;
    }

    a{ color: inherit; }
    .wrap{ max-width: var(--maxw); margin: 0 auto; }

    /* Topbar */
    .topbar{
      position: sticky; top: 12px; z-index: 50;
      border-radius: 999px;
      padding: 12px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      backdrop-filter: blur(14px);
      background: color-mix(in srgb, var(--card) 82%, transparent);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      flex-wrap: wrap;
    }
    .left, .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .brand{
      display:flex; gap:12px; align-items:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--card2) 85%, transparent);
      border: 1px solid var(--stroke2);
      min-width: 240px;
    }
    .logo{
      width: 28px; height: 28px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,255,255,.25));
      border: 1px solid var(--stroke2);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .brand b{ display:block; font-size: 14px; letter-spacing:.2px; }
    .brand span{ display:block; font-size: 12.5px; color: var(--muted); margin-top: 2px; }

    button, input{
      font: inherit;
      color: var(--text);
      background: color-mix(in srgb, var(--card2) 85%, transparent);
      border: 1px solid var(--stroke2);
      border-radius: 999px;
      padding: 10px 12px;
      outline: none;
    }
    button{ cursor:pointer; transition: transform .08s ease, background .15s ease, border-color .15s ease; }
    button:hover{ background: color-mix(in srgb, var(--card) 92%, transparent); border-color: var(--stroke); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .ghost{ background: transparent; }
    .danger{ border-color: color-mix(in srgb, var(--bad) 35%, var(--stroke2)); }
    .primary{
      background: color-mix(in srgb, var(--text) 12%, transparent);
      border-color: color-mix(in srgb, var(--text) 24%, var(--stroke2));
    }

    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card2) 85%, transparent);
      color: var(--muted);
      font-size: 12.5px;
      white-space: nowrap;
    }

    /* Progress ring */
    .ringWrap{ display:flex; gap:10px; align-items:center; }
    .ring{
      width: 44px; height: 44px;
      border-radius: 999px;
      background: conic-gradient(var(--accent) var(--p,0%), var(--ringBg) 0);
      display:grid; place-items:center;
      border: 1px solid var(--stroke2);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .ring > div{
      width: 32px; height: 32px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--bg1) 70%, transparent);
      border: 1px solid var(--stroke2);
      display:grid; place-items:center;
      font-size: 11px;
      color: var(--muted);
    }

    /* Layout */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .side{ order: 2; }
      .brand{ min-width: unset; }
    }

    .card{
      border-radius: var(--radius);
      background: color-mix(in srgb, var(--card) 85%, transparent);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardPad{ padding: 16px; }

    /* Main question */
    .subtitle{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      color: var(--muted);
      font-size: 12.5px;
    }
    .qtitle{
      margin: 10px 0 8px;
      font-size: 18px;
      letter-spacing: .1px;
    }

    .opts{ display:flex; flex-direction:column; gap: 10px; margin-top: 10px; }

    .opt{
      display:flex; gap:12px; align-items:flex-start;
      padding: 12px 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card2) 85%, transparent);
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .opt:hover{
      transform: translateY(-1px);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border-color: var(--stroke);
    }
    .opt:active{ transform: translateY(0px); }
    .opt input{ margin-top: 3px; accent-color: var(--accent); }
    .opt .letter{
      width: 30px; height: 30px;
      border-radius: 12px;
      display:grid; place-items:center;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card) 70%, transparent);
      color: var(--muted);
      font-weight: 700;
      flex: 0 0 auto;
    }
    .opt .txt{ flex:1; }
    .opt .txt b{ font-size: 13px; color: var(--muted2); font-weight: 650; margin-right: 6px; }
    .opt.correct{ border-color: color-mix(in srgb, var(--ok) 55%, var(--stroke)); background: color-mix(in srgb, var(--ok) 14%, transparent); }
    .opt.wrong{ border-color: color-mix(in srgb, var(--bad) 55%, var(--stroke)); background: color-mix(in srgb, var(--bad) 14%, transparent); }
    .opt.warn{ border-color: color-mix(in srgb, var(--warn) 55%, var(--stroke)); background: color-mix(in srgb, var(--warn) 12%, transparent); }

    .sep{
      height: 1px;
      background: var(--stroke2);
      margin: 14px 0;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .toggle{
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card2) 85%, transparent);
      color: var(--muted);
    }
    .toggle input{ width: 18px; height: 18px; }

    .feedback{
      color: var(--muted);
      font-size: 13px;
      min-height: 18px;
    }

    /* Side */
    .sideHead{
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border-bottom: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card2) 75%, transparent);
    }
    .sideHead strong{ font-size: 13.5px; }
    .searchWrap{ padding: 14px 16px; }
    .search{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card2) 85%, transparent);
    }
    .filters{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card2) 80%, transparent);
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, border-color .15s ease;
      font-size: 12.5px;
    }
    .chip:hover{ border-color: var(--stroke); }
    .chip.on{
      background: color-mix(in srgb, var(--text) 10%, transparent);
      border-color: color-mix(in srgb, var(--text) 20%, var(--stroke2));
      color: var(--text);
    }

    .numsWrap{ padding: 0 16px 16px; }
    .nums{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    .num{
      padding: 10px 0;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card2) 82%, transparent);
      text-align:center;
      cursor:pointer;
      user-select:none;
      font-size: 12.5px;
      color: var(--muted);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .num:hover{ transform: translateY(-1px); border-color: var(--stroke); background: color-mix(in srgb, var(--card) 92%, transparent); }
    .num:active{ transform:none; }
    .num.cur{
      outline: 2px solid color-mix(in srgb, var(--text) 28%, transparent);
      color: var(--text);
    }
    .num.ans{ color: var(--text); border-color: color-mix(in srgb, var(--text) 22%, var(--stroke2)); }
    .num.flag{
      background: color-mix(in srgb, var(--warn) 12%, transparent);
      border-color: color-mix(in srgb, var(--warn) 35%, var(--stroke2));
      color: var(--text);
    }
    .num.ok{ border-color: color-mix(in srgb, var(--ok) 55%, var(--stroke2)); }
    .num.bad{ border-color: color-mix(in srgb, var(--bad) 55%, var(--stroke2)); }

    .sideFooter{
      padding: 14px 16px;
      border-top: 1px solid var(--stroke2);
      color: var(--muted);
      font-size: 12.5px;
      background: color-mix(in srgb, var(--card2) 75%, transparent);
    }

    /* Drawer (settings) */
    dialog{
      width: min(720px, 92vw);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      color: var(--text);
      box-shadow: var(--shadow);
      padding: 0;
      overflow:hidden;
      backdrop-filter: blur(16px);
    }
    dialog::backdrop{ background: rgba(0,0,0,.45); }
    .dlgHead{
      padding: 14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card2) 75%, transparent);
    }
    .dlgBody{ padding: 14px 16px; }
    .dlgFoot{
      padding: 14px 16px;
      border-top: 1px solid var(--stroke2);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
      background: color-mix(in srgb, var(--card2) 75%, transparent);
    }
    .formRow{
      display:flex; gap:14px; flex-wrap:wrap; align-items:center;
      margin: 10px 0;
      color: var(--muted);
      font-size: 13px;
    }
    .formRow label{ display:flex; gap:10px; align-items:center; }
    input[type="number"]{
      width: 150px;
      border-radius: 14px;
      padding: 11px 12px;
    }
    .hint{ color: var(--muted2); font-size: 12.5px; margin-top: 10px; }

    /* Toast */
    .toast{
      position: fixed; right: 18px; bottom: 18px;
      border-radius: 16px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
      padding: 10px 12px;
      color: var(--muted);
      opacity: 0;
      transform: translateY(10px);
      transition: .18s ease;
      pointer-events:none;
      z-index: 999;
      font-size: 13px;
    }
    .toast.show{ opacity: 1; transform: translateY(0); }

    /* Timer pill emphasize */
    .timerOn{ border-color: color-mix(in srgb, var(--warn) 30%, var(--stroke2)); }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="left">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <b>Moodle SCM</b>
          <span id="smallStatus">Tecniche Investigative</span>
        </div>
      </div>

      <button id="newBtn" class="primary" title="Nuovo quiz (N)">Nuovo</button>
      <button id="gradeBtn" title="Correggi (G)">Correggi</button>
      <button id="reviewBtn" title="Vai alla prima sbagliata" style="display:none;">Rivedi errori</button>
      <button id="settingsBtn" class="ghost" title="Impostazioni (S)">Impostazioni</button>
      <button id="resetBtn" class="danger" title="Reset (cancella salvataggio)">Reset</button>
    </div>

    <div class="right">
      <div class="ringWrap" title="Progresso risposte">
        <div class="ring" id="ring" style="--p:0%;">
          <div id="ringTxt">0%</div>
        </div>
        <span class="pill" id="scorePill">‚Äî</span>
      </div>

      <span class="pill" id="timerPill" style="display:none;">‚è±Ô∏è <span id="timerTxt">00:00</span></span>
      <button id="themeBtn" title="Tema">üåô</button>
    </div>
  </div>

  <div class="grid">
    <!-- MAIN -->
    <main class="card">
      <div class="cardPad">
        <div class="subtitle" id="subtitle"></div>
        <h2 class="qtitle" id="qtitle"></h2>

        <div class="opts" id="opts"></div>

        <div class="sep"></div>

        <div class="row">
          <div class="actions">
            <button id="prevBtn" title="Prev (‚Üê)">‚Üê Prev</button>
            <button id="nextBtn" title="Next (‚Üí)">Next ‚Üí</button>
            <button id="flagBtn" title="Segna/Unsegna (F)">üö© Segna</button>
            <button id="jumpUnansweredBtn" title="Vai alla prima non risposta" style="display:none;">Vai a non risposte</button>
          </div>

          <div class="actions">
            <div class="toggle" title="Mostra subito giusta/sbagliata">
              <label style="display:flex;gap:10px;align-items:center;cursor:pointer;">
                <input type="checkbox" id="instantChk" checked />
                Feedback subito
              </label>
            </div>

            <div class="toggle" title="Dopo la risposta passa alla domanda successiva">
              <label style="display:flex;gap:10px;align-items:center;cursor:pointer;">
                <input type="checkbox" id="autoNextChk" />
                Auto-next
              </label>
            </div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="feedback" id="feedback"></div>
      </div>
    </main>

    <!-- SIDE -->
    <aside class="card side">
      <div class="sideHead">
        <strong>Navigazione</strong>
        <span class="pill" id="navPill">‚Äî</span>
      </div>

      <div class="searchWrap">
        <input id="searchBox" class="search" type="search" placeholder="Cerca testo nella domanda..." />
        <div class="filters">
          <div class="chip on" id="chipAll">Tutte</div>
          <div class="chip" id="chipUnanswered">Non risposte</div>
          <div class="chip" id="chipFlagged">Segnate üö©</div>
          <div class="chip" id="chipWrong">Sbagliate</div>
        </div>
      </div>

      <div class="numsWrap">
        <div class="nums" id="nums"></div>
      </div>

      <div class="sideFooter">
        Le risposte sono salvate sul dispositivo. Scorciatoie: ‚Üê ‚Üí, F, G, N, S.
      </div>
    </aside>
  </div>
</div>

<dialog id="dlg">
  <div class="dlgHead">
    <strong>Impostazioni</strong>
    <button id="closeDlg">Chiudi</button>
  </div>

  <div class="dlgBody">
    <div class="formRow">
      <label><input type="checkbox" id="shuffleQ" checked /> Domande random</label>
      <label><input type="checkbox" id="shuffleO" checked /> Opzioni random</label>
    </div>

    <div class="formRow">
      <label>Numero domande:
        <input type="number" id="limitN" min="1" step="1" placeholder="tutte" />
      </label>

      <label><input type="checkbox" id="useTimer" /> Timer</label>

      <label>Minuti:
        <input type="number" id="timerMin" min="1" step="1" value="30" />
      </label>
    </div>

    <div class="hint">
      ‚Ä¢ Se ‚ÄúNumero domande‚Äù √® vuoto: usa tutte (168).<br/>
      ‚Ä¢ Timer: allo scadere corregge automaticamente.
    </div>
  </div>

  <div class="dlgFoot">
    <button id="applyBtn" class="primary">Applica e ricomincia</button>
  </div>
</dialog>

<div class="toast" id="toast">Salvato</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const STORAGE_KEY = "quiz_state_tecniche_vFINAL";

  let SOURCE = [];
  let state = {
    settings: { shuffleQ: true, shuffleO: true, limitN: null, useTimer: false, timerMin: 30 },
    order: [],
    map: {},
    answers: {},
    flagged: {},
    idx: 0,
    graded: false,
    wrongIds: [],
    filter: "all",
    search: "",
    instant: true,
    autoNext: false,
    timer: { startTs: null, running: false }
  };

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function toast(msg){
    const t = $("toast");
    t.textContent = msg || "Salvato";
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 850);
  }

  function save(silent=false){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      if(!silent) toast("Salvato");
    }catch(e){}
  }
  function loadSaved(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      const s = JSON.parse(raw);
      if(!s || !s.order || !s.map) return false;
      state = s;
      return true;
    }catch(e){ return false; }
  }
  function resetSaved(){ localStorage.removeItem(STORAGE_KEY); }

  function currentId(){ return state.order[state.idx]; }
  function answeredCount(){ return Object.keys(state.answers || {}).length; }
  function totalCount(){ return (state.order || []).length; }

  function buildQuizFromSource(){
    let src = [...SOURCE].sort((a,b)=>a.id-b.id);
    const n = state.settings.limitN;
    if (Number.isFinite(n) && n > 0) src = src.slice(0, n);

    let ids = src.map(q => q.id);
    if (state.settings.shuffleQ) shuffle(ids);

    const labels = ["A","B","C","D"];
    const map = {};

    for(const q of src){
      // corretta sorgente = A (come la tua BD), poi rimescoliamo in UI
      let opts = [
        { text: q.options.A, isCorrect: true },
        { text: q.options.B, isCorrect: false },
        { text: q.options.C, isCorrect: false },
        { text: q.options.D, isCorrect: false },
      ];
      if (state.settings.shuffleO) shuffle(opts);

      const mapped = opts.map((o,i) => ({ label: labels[i], text: o.text, isCorrect: o.isCorrect }));
      const correctIndex = mapped.findIndex(o => o.isCorrect);
      map[q.id] = { question: q.question, options: mapped, correctIndex };
    }

    state.order = ids;
    state.map = map;
    state.answers = {};
    state.flagged = {};
    state.idx = 0;
    state.graded = false;
    state.wrongIds = [];
    state.filter = "all";
    state.search = "";
    state.instant = true;
    state.timer = { startTs: null, running: false };

    save(true);
    updateTimerUI();
    startTimerIfNeeded(true);
    renderAll();
  }

  // Timer
  let timerHandle = null;
  function pad2(n){ return String(n).padStart(2,'0'); }
  function updateTimerUI(){
    $("timerPill").style.display = state.settings.useTimer ? "" : "none";
    $("timerPill").classList.toggle("timerOn", !!state.settings.useTimer);
  }
  function stopTimer(){ if(timerHandle) clearInterval(timerHandle); timerHandle = null; }
  function startTimerIfNeeded(restart=false){
    stopTimer();
    if(!state.settings.useTimer){
      state.timer = { startTs: null, running: false };
      $("timerTxt").textContent = "00:00";
      save(true);
      return;
    }
    if(restart || !state.timer || !state.timer.running || !state.timer.startTs){
      state.timer = { startTs: Date.now(), running: true };
      save(true);
    }
    tickTimer();
    timerHandle = setInterval(tickTimer, 1000);
  }
  function tickTimer(){
    if(!state.settings.useTimer) return;
    if(!state.timer || !state.timer.running || !state.timer.startTs) return;

    const mins = Number(state.settings.timerMin || 30);
    const limitMs = mins * 60 * 1000;
    const elapsed = Date.now() - state.timer.startTs;
    const left = Math.max(0, limitMs - elapsed);

    const mm = Math.floor(left / 60000);
    const ss = Math.floor((left % 60000) / 1000);
    $("timerTxt").textContent = `${pad2(mm)}:${pad2(ss)}`;

    if(left === 0){
      state.timer.running = false;
      save(true);
      gradeAll(true);
      stopTimer();
      alert("Tempo scaduto: quiz corretto.");
    }
  }

  // Grading
  function gradeAll(silent=false){
    const wrong = [];
    for(const id of state.order){
      const q = state.map[id];
      const chosen = state.answers[id];
      if(chosen === undefined || chosen !== q.correctIndex) wrong.push(id);
    }
    state.graded = true;
    state.wrongIds = wrong;
    save(silent);

    $("reviewBtn").style.display = wrong.length ? "" : "none";
    renderQuestion();
    renderSide();
    updateTop();
    updateJumpButtons();
    renderFeedbackSummary();
  }
  function renderFeedbackSummary(){
    const total = totalCount();
    const wrong = (state.wrongIds || []).length;
    const correct = total - wrong;
    const unanswered = state.order.filter(id => state.answers[id] === undefined).length;
    $("feedback").textContent = `Risultato: ${correct}/${total}. Errori: ${wrong}. Non risposte: ${unanswered}.`;
  }

  // UI
  function updateTop(){
    const total = totalCount();
    const ans = answeredCount();
    const wrong = (state.wrongIds || []).length;
    const correct = total ? (total - wrong) : 0;

    const pct = total ? Math.round((ans/total)*100) : 0;

    $("navPill").textContent = `${ans}/${total}`;
    $("smallStatus").textContent = state.graded
      ? `Punteggio: ${correct}/${total}`
      : `Tecniche Investigative ‚Ä¢ Risposte: ${ans}/${total}`;

    $("scorePill").textContent = state.graded ? `‚úÖ ${correct}/${total}` : `‚è≥ ${ans}/${total}`;

    // Ring
    $("ring").style.setProperty("--p", pct + "%");
    $("ringTxt").textContent = pct + "%";
  }

  function updateJumpButtons(){
    const unanswered = state.order.some(id => state.answers[id] === undefined);
    $("jumpUnansweredBtn").style.display = unanswered ? "" : "none";
  }

  function renderQuestion(){
    const id = currentId();
    const q = state.map[id];
    const total = totalCount();

    $("subtitle").innerHTML = `
      <span class="pill">Domanda ${state.idx+1} / ${total}</span>
      ${state.flagged[id] ? '<span class="pill">üö© Segnata</span>' : ''}
      ${state.answers[id] !== undefined ? '<span class="pill">Risposta data</span>' : '<span class="pill">Non risposta</span>'}
    `;

    $("qtitle").textContent = q.question;

    const chosen = state.answers[id];
    const optsEl = $("opts");
    optsEl.innerHTML = "";

    q.options.forEach((o, i) => {
      const lab = document.createElement("label");
      lab.className = "opt";
      lab.setAttribute("role", "button");

      const inp = document.createElement("input");
      inp.type = "radio";
      inp.name = "q_" + id;
      inp.value = String(i);
      inp.checked = (chosen === i);

      inp.addEventListener("change", () => {
        state.answers[id] = i;
        state.graded = false;
        state.wrongIds = [];
        $("reviewBtn").style.display = "none";

        save(true);
        updateTop();
        updateJumpButtons();
        renderSide();

        if(state.instant) markCurrentInstant();
        else $("feedback").textContent = "";

        if(state.autoNext){
          // piccola pausa per far vedere il feedback
          setTimeout(() => {
            if(state.idx < totalCount() - 1){
              state.idx++;
              save(true);
              renderAll();
            }
          }, 550);
        }
      });

      const letter = document.createElement("div");
      letter.className = "letter";
      letter.textContent = o.label;

      const text = document.createElement("div");
      text.className = "txt";
      text.innerHTML = `<b>${o.label})</b> ${escapeHtml(o.text)}`;

      lab.appendChild(inp);
      lab.appendChild(letter);
      lab.appendChild(text);
      optsEl.appendChild(lab);
    });

    $("prevBtn").disabled = state.idx === 0;
    $("nextBtn").disabled = state.idx === total - 1;

    $("flagBtn").textContent = state.flagged[id] ? "üö© Segnata" : "üö© Segna";

    if(state.graded) markCurrentGraded();
    if(state.instant && state.answers[id] !== undefined) markCurrentInstant();
  }

  function markCurrentGraded(){
    const id = currentId();
    const q = state.map[id];
    const chosen = state.answers[id];
    const labels = Array.from(document.querySelectorAll("#opts .opt"));

    labels.forEach((el, idx) => {
      el.classList.remove("correct","wrong","warn");
      if(idx === q.correctIndex) el.classList.add("correct");
      if(chosen !== undefined && chosen !== q.correctIndex && idx === chosen) el.classList.add("wrong");
      if(chosen === undefined && idx === q.correctIndex) el.classList.add("warn");
    });
  }

  function markCurrentInstant(){
    const id = currentId();
    const q = state.map[id];
    const chosen = state.answers[id];
    const labels = Array.from(document.querySelectorAll("#opts .opt"));

    labels.forEach(el => el.classList.remove("correct","wrong","warn"));
    if(chosen === undefined) return;

    if(chosen === q.correctIndex){
      labels[chosen].classList.add("correct");
      $("feedback").textContent = "‚úÖ Corretta";
    } else {
      labels[chosen].classList.add("wrong");
      labels[q.correctIndex].classList.add("correct");
      $("feedback").textContent = "‚ùå Sbagliata (mostro anche la corretta)";
    }
  }

  function passesFilter(id){
    const q = state.map[id];
    const chosen = state.answers[id];
    const flagged = !!state.flagged[id];
    const wrong = state.graded && chosen !== undefined && chosen !== q.correctIndex;

    if(state.search){
      const hay = (q.question || "").toLowerCase();
      if(!hay.includes(state.search.toLowerCase())) return false;
    }
    if(state.filter === "all") return true;
    if(state.filter === "unanswered") return chosen === undefined;
    if(state.filter === "flagged") return flagged;
    if(state.filter === "wrong") return state.graded && wrong;
    return true;
  }

  function renderSide(){
    const nums = $("nums");
    nums.innerHTML = "";

    state.order.forEach((id, i) => {
      if(!passesFilter(id)) return;

      const q = state.map[id];
      const chosen = state.answers[id];

      const d = document.createElement("div");
      d.className = "num";
      d.textContent = String(i+1);

      if(i === state.idx) d.classList.add("cur");
      if(chosen !== undefined) d.classList.add("ans");
      if(state.flagged[id]) d.classList.add("flag");

      if(state.graded && chosen !== undefined){
        if(chosen === q.correctIndex) d.classList.add("ok");
        else d.classList.add("bad");
      }

      d.title = `Vai alla domanda ${i+1}`;
      d.addEventListener("click", () => {
        state.idx = i;
        save(true);
        renderAll();
      });

      nums.appendChild(d);
    });
  }

  function renderAll(){
    $("searchBox").value = state.search || "";
    $("instantChk").checked = !!state.instant;
    $("autoNextChk").checked = !!state.autoNext;

    $("chipAll").classList.toggle("on", state.filter === "all");
    $("chipUnanswered").classList.toggle("on", state.filter === "unanswered");
    $("chipFlagged").classList.toggle("on", state.filter === "flagged");
    $("chipWrong").classList.toggle("on", state.filter === "wrong");

    renderQuestion();
    renderSide();
    updateTop();
    updateJumpButtons();
    if(state.graded) renderFeedbackSummary();
  }

  // Filters
  function setFilter(f){
    state.filter = f;
    save(true);
    renderSide();
  }
  $("chipAll").addEventListener("click", () => setFilter("all"));
  $("chipUnanswered").addEventListener("click", () => setFilter("unanswered"));
  $("chipFlagged").addEventListener("click", () => setFilter("flagged"));
  $("chipWrong").addEventListener("click", () => {
    if(!state.graded){
      alert("Prima premi ‚ÄúCorreggi‚Äù per vedere le sbagliate.");
      return;
    }
    setFilter("wrong");
  });

  // Search
  $("searchBox").addEventListener("input", (e) => {
    state.search = e.target.value.trim();
    save(true);
    renderSide();
  });

  // Nav buttons
  $("prevBtn").addEventListener("click", () => {
    if(state.idx > 0){ state.idx--; save(true); renderAll(); }
  });
  $("nextBtn").addEventListener("click", () => {
    if(state.idx < totalCount() - 1){ state.idx++; save(true); renderAll(); }
  });

  // Flag
  $("flagBtn").addEventListener("click", () => {
    const id = currentId();
    state.flagged[id] = !state.flagged[id];
    save(true);
    renderAll();
  });

  // Instant + autoNext
  $("instantChk").addEventListener("change", (e) => {
    state.instant = !!e.target.checked;
    save(true);
    if(state.instant) markCurrentInstant();
    else if(state.graded) markCurrentGraded();
    else $("feedback").textContent = "";
  });
  $("autoNextChk").addEventListener("change", (e) => {
    state.autoNext = !!e.target.checked;
    save(true);
  });

  // New / Grade / Review / Reset
  $("newBtn").addEventListener("click", () => buildQuizFromSource());
  $("gradeBtn").addEventListener("click", () => { gradeAll(true); toast("Corretto"); });
  $("reviewBtn").addEventListener("click", () => {
    if(!state.graded || !(state.wrongIds || []).length) return;
    const firstWrong = state.wrongIds[0];
    const i = state.order.indexOf(firstWrong);
    if(i >= 0){ state.idx = i; save(true); renderAll(); }
  });
  $("jumpUnansweredBtn").addEventListener("click", () => {
    const i = state.order.findIndex(id => state.answers[id] === undefined);
    if(i >= 0){ state.idx = i; save(true); renderAll(); }
    else alert("Hai risposto a tutte.");
  });
  $("resetBtn").addEventListener("click", () => {
    if(confirm("Vuoi cancellare il salvataggio e ricominciare?")){
      resetSaved();
      location.reload();
    }
  });

  // Settings dialog
  const dlg = $("dlg");
  $("settingsBtn").addEventListener("click", () => {
    $("shuffleQ").checked = !!state.settings.shuffleQ;
    $("shuffleO").checked = !!state.settings.shuffleO;
    $("limitN").value = state.settings.limitN ?? "";
    $("useTimer").checked = !!state.settings.useTimer;
    $("timerMin").value = state.settings.timerMin ?? 30;
    dlg.showModal();
  });
  $("closeDlg").addEventListener("click", () => dlg.close());
  $("applyBtn").addEventListener("click", () => {
    state.settings.shuffleQ = $("shuffleQ").checked;
    state.settings.shuffleO = $("shuffleO").checked;

    const lim = $("limitN").value.trim();
    state.settings.limitN = lim ? Math.max(1, parseInt(lim,10)) : null;

    state.settings.useTimer = $("useTimer").checked;
    state.settings.timerMin = Math.max(1, parseInt($("timerMin").value || "30", 10));

    dlg.close();
    updateTimerUI();
    buildQuizFromSource();
  });

  // Theme
  function setTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem("quiz_theme", t);
    $("themeBtn").textContent = (t === "light") ? "üåô" : "‚òÄÔ∏è";
  }
  $("themeBtn").addEventListener("click", () => {
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
  });

  // Shortcuts
  document.addEventListener("keydown", (e) => {
    if(e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;
    if(e.key === "ArrowLeft") $("prevBtn").click();
    if(e.key === "ArrowRight") $("nextBtn").click();
    if(e.key === "f" || e.key === "F") $("flagBtn").click();
    if(e.key === "g" || e.key === "G") $("gradeBtn").click();
    if(e.key === "n" || e.key === "N") $("newBtn").click();
    if(e.key === "s" || e.key === "S") $("settingsBtn").click();
  });

  // Load questions.json
  async function loadQuestions(){
    const res = await fetch("./questions.json", { cache: "no-store" });
    if(!res.ok) throw new Error("Impossibile caricare questions.json");
    const data = await res.json();
    if(!Array.isArray(data) || !data.length) throw new Error("questions.json vuoto o non valido");
    return data;
  }

  (async () => {
    const theme = localStorage.getItem("quiz_theme") || "dark";
    setTheme(theme);

    try{
      SOURCE = await loadQuestions();
    }catch(err){
      $("smallStatus").textContent = "Errore caricamento domande";
      $("scorePill").textContent = "‚ùå";
      $("feedback").textContent = "Non riesco a leggere ./questions.json. Controlla che sia in docs/ insieme a index.html.";
      console.error(err);
      return;
    }

    const hasSaved = loadSaved();
    updateTimerUI();

    // Forza feedback immediato sempre
    state.instant = true;
    save(true);

    if(!hasSaved || !state.order || !state.order.length || !state.map){
      buildQuizFromSource();
    } else {
      startTimerIfNeeded(false);
      renderAll();
    }

    updateTop();
    updateJumpButtons();
  })();
})();
</script>
</body>
</html>
