<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz ‚Äì Tecniche Investigative</title>
  <meta name="description" content="Quiz Tecniche Investigative: UI professionale, punteggio configurabile e per domanda, modalit√† esame, timer, filtri, export, salvataggio." />

  <style>
    :root{
      --bg: #0b1020;
      --surface: #0f172a;
      --surface2:#111c35;
      --surface3:#0b132b;
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.07);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.64);
      --muted2: rgba(255,255,255,.44);

      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --info:#60a5fa;

      --shadow: 0 22px 60px rgba(0,0,0,.48);
      --shadow2: 0 12px 34px rgba(0,0,0,.35);

      --r1: 18px;
      --r2: 14px;

      --maxw: 1240px;
    }

    [data-theme="light"]{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --surface2:#fbfbfd;
      --surface3:#f3f5fb;
      --stroke: rgba(0,0,0,.10);
      --stroke2: rgba(0,0,0,.06);

      --text: rgba(0,0,0,.88);
      --muted: rgba(0,0,0,.62);
      --muted2: rgba(0,0,0,.44);

      --shadow: 0 22px 60px rgba(0,0,0,.10);
      --shadow2: 0 12px 34px rgba(0,0,0,.08);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      line-height: 1.35;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 12% 12%, color-mix(in srgb, var(--info) 22%, transparent), transparent 55%),
        radial-gradient(900px 600px at 86% 18%, color-mix(in srgb, var(--ok) 16%, transparent), transparent 55%),
        radial-gradient(900px 700px at 70% 95%, color-mix(in srgb, var(--warn) 12%, transparent), transparent 55%),
        linear-gradient(180deg, var(--bg), color-mix(in srgb, var(--bg) 85%, #000));
      padding: 18px;
    }

    .wrap{ max-width: var(--maxw); margin: 0 auto; }

    header{
      position: sticky; top: 12px; z-index: 50;
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; flex-wrap: wrap;

      padding: 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 90%, transparent);
      min-width: 300px;
    }
    .logo{
      width: 30px; height: 30px;
      border-radius: 12px;
      border: 1px solid var(--stroke2);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,255,255,.18));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .brand b{ display:block; font-size: 14px; letter-spacing: .2px; }
    .brand span{ display:block; font-size: 12.5px; color: var(--muted); margin-top: 2px; }

    .rowBtns{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    button, input, select{
      font: inherit;
      color: var(--text);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      border: 1px solid var(--stroke2);
      border-radius: 999px;
      padding: 10px 12px;
      outline: none;
    }
    button{
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    button:hover{ background: color-mix(in srgb, var(--surface) 92%, transparent); border-color: var(--stroke); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .primary{
      background: color-mix(in srgb, var(--text) 10%, transparent);
      border-color: color-mix(in srgb, var(--text) 20%, var(--stroke2));
    }
    .danger{ border-color: color-mix(in srgb, var(--bad) 40%, var(--stroke2)); }
    .ghost{ background: transparent; }

    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 90%, transparent);
      color: var(--muted);
      font-size: 12.5px;
      white-space: nowrap;
    }
    .pill strong{ color: var(--text); font-weight: 700; }
    .pill.ok{ border-color: color-mix(in srgb, var(--ok) 40%, var(--stroke2)); }
    .pill.bad{ border-color: color-mix(in srgb, var(--bad) 40%, var(--stroke2)); }
    .pill.warn{ border-color: color-mix(in srgb, var(--warn) 40%, var(--stroke2)); }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 400px;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 1040px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    .card{
      border-radius: var(--r1);
      border: 1px solid var(--stroke);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .pad{ padding: 16px; }

    .meta{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      color: var(--muted);
      font-size: 12.5px;
    }
    .qTitle{
      margin: 10px 0 10px;
      font-size: 18px;
      letter-spacing: .1px;
    }

    .controlsTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin: 10px 0 6px;
    }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .toggle{
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      color: var(--muted);
      font-size: 12.5px;
      user-select:none;
    }
    .toggle input{ width: 18px; height: 18px; }

    .pointsBox{
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      color: var(--muted);
      font-size: 12.5px;
    }
    .pointsBox input{
      width: 92px;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
    }

    .opts{ display:flex; flex-direction:column; gap: 10px; margin-top: 10px; }
    .opt{
      display:flex; gap:12px; align-items:flex-start;
      padding: 12px 12px;
      border-radius: var(--r2);
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .opt:hover{
      transform: translateY(-1px);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      border-color: var(--stroke);
    }
    .opt:active{ transform:none; }
    .opt input{ margin-top: 3px; accent-color: var(--text); }
    .badge{
      width: 32px; height: 32px;
      border-radius: 12px;
      border: 1px solid var(--stroke2);
      display:grid; place-items:center;
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      color: var(--muted);
      font-weight: 800;
      flex: 0 0 auto;
    }
    .opt.correct{ border-color: color-mix(in srgb, var(--ok) 55%, var(--stroke2)); background: color-mix(in srgb, var(--ok) 12%, transparent); }
    .opt.wrong{ border-color: color-mix(in srgb, var(--bad) 55%, var(--stroke2)); background: color-mix(in srgb, var(--bad) 12%, transparent); }
    .opt.warn{ border-color: color-mix(in srgb, var(--warn) 55%, var(--stroke2)); background: color-mix(in srgb, var(--warn) 10%, transparent); }

    .sep{ height:1px; background: var(--stroke2); margin: 14px 0; }
    .feedback{ color: var(--muted); font-size: 13px; min-height: 18px; }

    .sideHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .sideHead strong{ font-size: 13.5px; letter-spacing:.2px; }

    .sideBody{ padding: 14px 16px 16px; }

    .search{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
    }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      font-size: 12.5px;
      transition: background .15s ease, border-color .15s ease;
    }
    .chip:hover{ border-color: var(--stroke); }
    .chip.on{
      background: color-mix(in srgb, var(--text) 10%, transparent);
      border-color: color-mix(in srgb, var(--text) 18%, var(--stroke2));
      color: var(--text);
    }

    .stats{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      border: 1px solid var(--stroke2);
      border-radius: 14px;
      padding: 10px 12px;
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
    }
    .stat b{
      display:block;
      font-size: 12px;
      color: var(--muted2);
      font-weight: 750;
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    .stat div{ margin-top: 5px; font-size: 15px; }

    .nums{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
    }
    .num{
      padding: 10px 0;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      text-align:center;
      cursor:pointer;
      user-select:none;
      font-size: 12.5px;
      color: var(--muted);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .num:hover{ transform: translateY(-1px); border-color: var(--stroke); background: color-mix(in srgb, var(--surface) 92%, transparent); }
    .num:active{ transform:none; }
    .num.cur{ outline: 2px solid color-mix(in srgb, var(--text) 20%, transparent); color: var(--text); }
    .num.ans{ color: var(--text); border-color: color-mix(in srgb, var(--text) 16%, var(--stroke2)); }
    .num.flag{ border-color: color-mix(in srgb, var(--warn) 35%, var(--stroke2)); background: color-mix(in srgb, var(--warn) 10%, transparent); color: var(--text); }
    .num.ok{ border-color: color-mix(in srgb, var(--ok) 55%, var(--stroke2)); }
    .num.bad{ border-color: color-mix(in srgb, var(--bad) 55%, var(--stroke2)); }

    .sideFooter{
      margin-top: 14px;
      color: var(--muted2);
      font-size: 12.5px;
    }

    dialog{
      width: min(880px, 94vw);
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      background: color-mix(in srgb, var(--surface) 96%, transparent);
      color: var(--text);
      box-shadow: var(--shadow);
      padding: 0;
      overflow:hidden;
      backdrop-filter: blur(16px);
    }
    dialog::backdrop{ background: rgba(0,0,0,.48); }

    .dlgHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .dlgBody{ padding: 14px 16px; }
    .dlgFoot{
      padding: 14px 16px;
      border-top: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }

    .section{
      border: 1px solid var(--stroke2);
      border-radius: 14px;
      padding: 12px;
      background: color-mix(in srgb, var(--surface2) 92%, transparent);
      margin-bottom: 12px;
    }
    .section h3{
      margin: 0 0 10px;
      font-size: 12px;
      color: var(--muted2);
      font-weight: 800;
      letter-spacing:.35px;
      text-transform: uppercase;
    }
    .formRow{
      display:flex; gap:14px; flex-wrap:wrap; align-items:center;
      margin: 10px 0;
      color: var(--muted);
      font-size: 13px;
    }
    .formRow label{ display:flex; gap:10px; align-items:center; }
    .formRow input[type="number"]{
      width: 160px;
      border-radius: 14px;
      padding: 11px 12px;
    }
    .hint{ color: var(--muted2); font-size: 12.5px; margin-top: 8px; }

    .list{
      display:flex; flex-direction:column; gap:8px;
      margin-top: 10px;
      max-height: 46vh;
      overflow:auto;
      padding-right: 4px;
    }
    .item{
      border: 1px solid var(--stroke2);
      border-radius: 14px;
      padding: 10px 12px;
      background: color-mix(in srgb, var(--surface3) 65%, transparent);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .item small{ color: var(--muted); }
    .item button{ padding: 8px 10px; }

    .toast{
      position: fixed; right: 18px; bottom: 18px;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
      padding: 10px 12px;
      color: var(--muted);
      opacity: 0;
      transform: translateY(10px);
      transition: .18s ease;
      pointer-events:none;
      z-index: 999;
      font-size: 13px;
    }
    .toast.show{ opacity: 1; transform: translateY(0); }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="brand" aria-label="Titolo">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <b>Quiz ‚Ä¢ Tecniche Investigative</b>
        <span id="subStatus">Caricamento domande‚Ä¶</span>
      </div>
    </div>

    <div class="rowBtns">
      <span class="pill" id="modePill" style="display:none;">Modalit√† esame</span>
      <span class="pill" id="timerPill" style="display:none;">‚è±Ô∏è <span id="timerTxt">00:00</span></span>
      <span class="pill" id="scorePill">‚Äî</span>

      <button id="newBtn" class="primary" title="Nuovo (N)">Nuovo</button>
      <button id="gradeBtn" title="Correggi (G)">Correggi</button>
      <button id="reportBtn" title="Report" style="display:none;">Report</button>
      <button id="repeatWrongBtn" title="Ripeti solo sbagliate" style="display:none;">Ripeti sbagliate</button>
      <button id="exportBtn" title="Esporta risultati (CSV)">Esporta</button>
      <button id="settingsBtn" class="ghost" title="Impostazioni (S)">Impostazioni</button>
      <button id="themeBtn" title="Tema">üåô</button>
      <button id="resetBtn" class="danger" title="Reset">Reset</button>
    </div>
  </header>

  <div class="grid">
    <main class="card" aria-label="Domanda">
      <div class="pad">
        <div class="meta" id="meta"></div>
        <h2 class="qTitle" id="qTitle"></h2>

        <div class="controlsTop">
          <div class="actions">
            <button id="prevBtn" title="Prev (‚Üê)">‚Üê Prev</button>
            <button id="nextBtn" title="Next (‚Üí)">Next ‚Üí</button>
            <button id="flagBtn" title="Segna/Unsegna (F)">üö© Segna</button>
            <button id="jumpUnansweredBtn" title="Vai alla prima non risposta" style="display:none;">Vai a non risposte</button>
          </div>

          <div class="actions">
            <div class="pointsBox" id="pointsBox" style="display:none;" title="Punti assegnati a questa domanda (solo se abilitato)">
              Punti domanda
              <input id="pointsInput" type="number" min="0" step="0.5" inputmode="decimal" />
            </div>

            <div class="toggle" title="Feedback immediato (disattivo in Modalit√† esame)">
              <label style="display:flex;gap:10px;align-items:center;cursor:pointer;">
                <input type="checkbox" id="instantChk" />
                Feedback
              </label>
            </div>

            <div class="toggle" title="Passa alla prossima dopo risposta">
              <label style="display:flex;gap:10px;align-items:center;cursor:pointer;">
                <input type="checkbox" id="autoNextChk" />
                Auto-next
              </label>
            </div>
          </div>
        </div>

        <div class="opts" id="opts"></div>

        <div class="sep"></div>
        <div class="feedback" id="feedback"></div>
      </div>
    </main>

    <aside class="card" aria-label="Navigazione">
      <div class="sideHead">
        <strong>Navigazione</strong>
        <span class="pill" id="navPill">‚Äî</span>
      </div>

      <div class="sideBody">
        <input id="searchBox" class="search" type="search" placeholder="Cerca nel testo della domanda‚Ä¶" />

        <div class="chips">
          <div class="chip on" id="chipAll">Tutte</div>
          <div class="chip" id="chipUnanswered">Non risposte</div>
          <div class="chip" id="chipFlagged">Segnate üö©</div>
          <div class="chip" id="chipWrong">Sbagliate</div>
          <div class="chip" id="chipCorrect">Corrette</div>
        </div>

        <div class="stats">
          <div class="stat"><b>Punteggio</b><div id="scoreStat">‚Äî</div></div>
          <div class="stat"><b>Massimo</b><div id="maxStat">‚Äî</div></div>
          <div class="stat"><b>Corrette</b><div id="okStat">‚Äî</div></div>
          <div class="stat"><b>Sbagliate</b><div id="badStat">‚Äî</div></div>
        </div>

        <div class="nums" id="nums"></div>

        <div class="sideFooter">
          Scorciatoie: ‚Üê ‚Üí, A/B/C/D (rispondi), Invio (next), F (flag), G (correggi), N (nuovo), S (impostazioni).<br/>
          Salvataggio automatico sul dispositivo.
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- SETTINGS -->
<dialog id="dlgSettings">
  <div class="dlgHead">
    <strong>Impostazioni</strong>
    <button id="closeSettings">Chiudi</button>
  </div>

  <div class="dlgBody">
    <div class="section">
      <h3>Preset</h3>
      <div class="formRow">
        <button id="presetPractice" class="primary" title="Allenamento: feedback ON, no timer">Allenamento</button>
        <button id="presetExam30" title="Esame: 30 domande, 30 min, no feedback">Esame 30</button>
        <button id="presetExam60" title="Esame: 60 domande, 60 min, no feedback">Esame 60</button>
      </div>
      <div class="hint">I preset applicano impostazioni e ricominciano.</div>
    </div>

    <div class="section">
      <h3>Quiz</h3>
      <div class="formRow">
        <label><input type="checkbox" id="shuffleQ" /> Domande random</label>
        <label><input type="checkbox" id="shuffleO" /> Opzioni random</label>
        <label><input type="checkbox" id="examMode" /> Modalit√† esame (nasconde feedback e punteggio finch√© non correggi)</label>
      </div>
      <div class="formRow">
        <label>Numero domande:
          <input type="number" id="limitN" min="1" step="1" placeholder="tutte" />
        </label>
        <label><input type="checkbox" id="useTimer" /> Timer</label>
        <label>Minuti:
          <input type="number" id="timerMin" min="1" step="1" value="30" />
        </label>
      </div>
      <div class="hint">Se ‚ÄúNumero domande‚Äù √® vuoto: usa tutte le domande del file.</div>
    </div>

    <div class="section">
      <h3>Comfort</h3>
      <div class="formRow">
        <label><input type="checkbox" id="instantSet" /> Feedback immediato</label>
        <label><input type="checkbox" id="showCorrectOnWrong" /> Se sbagli, mostra anche la corretta</label>
        <label><input type="checkbox" id="autoNextSet" /> Auto-next</label>
      </div>
      <div class="hint">In Modalit√† esame, il feedback viene forzato OFF.</div>
    </div>

    <div class="section">
      <h3>Punteggio</h3>
      <div class="formRow">
        <label>Punti corretta:
          <input type="number" id="ptCorrect" step="0.5" value="1" />
        </label>
        <label>Punti sbagliata:
          <input type="number" id="ptWrong" step="0.5" value="0" />
        </label>
        <label>Punti non risposta:
          <input type="number" id="ptBlank" step="0.5" value="0" />
        </label>
      </div>

      <div class="formRow">
        <label><input type="checkbox" id="perQPoints" /> Punti per singola domanda</label>
        <button id="applyPointsAllBtn" title="Applica 'Punti corretta' a tutte le domande">Applica punti a tutte</button>
        <button id="resetPointsBtn" title="Ripristina i punti delle domande al default">Ripristina punti</button>
      </div>

      <div class="hint">
        Default: corretta=1, sbagliata=0, non risposta=0.<br/>
        Se attivi ‚Äúpunti per singola domanda‚Äù, puoi cambiare i punti direttamente in ogni domanda.
      </div>
    </div>
  </div>

  <div class="dlgFoot">
    <span class="pill">Applica e ricomincia per rendere effettive le modifiche.</span>
    <button id="applySettings" class="primary">Applica e ricomincia</button>
  </div>
</dialog>

<!-- REPORT -->
<dialog id="dlgReport">
  <div class="dlgHead">
    <strong>Report</strong>
    <button id="closeReport">Chiudi</button>
  </div>
  <div class="dlgBody">
    <div class="section">
      <h3>Riepilogo</h3>
      <div class="formRow" id="reportSummary"></div>
    </div>
    <div class="section">
      <h3>Errori (clicca per andare)</h3>
      <div class="list" id="wrongList"></div>
    </div>
  </div>
  <div class="dlgFoot">
    <span class="pill">Suggerimento: ‚ÄúRipeti sbagliate‚Äù crea un quiz solo con gli errori.</span>
    <button id="repeatWrongBtn2" class="primary">Ripeti sbagliate</button>
  </div>
</dialog>

<div class="toast" id="toast">Salvato</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const APP_VERSION = "ti_quiz_impeccabile_v1";
  const STORAGE_KEY = "ti_quiz_state_impeccabile";
  const THEME_KEY = "ti_theme_impeccabile";
  const LABELS = ["A","B","C","D"];

  let SOURCE = [];
  let timerHandle = null;

  let state = {
    version: APP_VERSION,
    settings: {
      shuffleQ: true,
      shuffleO: true,
      limitN: null,
      useTimer: false,
      timerMin: 30,

      examMode: false,

      instant: true,
      showCorrectOnWrong: true,
      autoNext: false,

      scoring: { correct: 1, wrong: 0, blank: 0 },
      perQuestionPoints: true
    },

    order: [],
    map: {},
    answers: {},
    flagged: {},
    points: {},
    idx: 0,

    graded: false,
    wrongIds: [],
    correctIds: [],

    filter: "all",
    search: "",

    timer: { startTs: null, running: false }
  };

  /* ---------------- Utils ---------------- */
  function toast(msg){
    const t = $("toast");
    t.textContent = msg || "Salvato";
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 850);
  }

  function safeNum(x, fallback){
    const n = Number(x);
    return Number.isFinite(n) ? n : fallback;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ‚úÖ MODIFICA: rimuove prefisso A)/B)/C)/D) (o A. / A: / A - ecc.) dal testo opzione
  function stripChoicePrefix(s){
    return String(s).replace(/^\s*[A-D]\s*[\)\.\-:]\s*/i, "");
  }

  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function save(silent=false){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      if(!silent) toast("Salvato");
    }catch(e){}
  }

  function loadSaved(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      const s = JSON.parse(raw);
      if(!s || !s.order || !s.map) return false;
      if(s.version !== APP_VERSION) return false;

      state = s;
      if(!state.settings?.scoring) state.settings.scoring = { correct: 1, wrong: 0, blank: 0 };
      if(typeof state.settings.perQuestionPoints !== "boolean") state.settings.perQuestionPoints = true;
      return true;
    }catch(e){ return false; }
  }

  function resetSaved(){
    localStorage.removeItem(STORAGE_KEY);
  }

  function currentId(){ return state.order[state.idx]; }
  function totalCount(){ return state.order.length; }
  function answeredCount(){ return Object.keys(state.answers || {}).length; }

  function ensurePointsForIds(ids){
    if(!state.points) state.points = {};
    const def = safeNum(state.settings.scoring.correct, 1);
    for(const id of ids){
      const v = safeNum(state.points[id], NaN);
      if(!Number.isFinite(v)) state.points[id] = def;
    }
  }

  function getPointsFor(id){
    if(!state.settings.perQuestionPoints) return safeNum(state.settings.scoring.correct, 1);
    const p = safeNum(state.points?.[id], NaN);
    return Number.isFinite(p) ? p : safeNum(state.settings.scoring.correct, 1);
  }

  /* ---------------- Build Quiz ---------------- */
  function buildQuizFromSource(customIds=null){
    let src = [...SOURCE].sort((a,b)=>a.id-b.id);

    if(Array.isArray(customIds) && customIds.length){
      const set = new Set(customIds);
      src = src.filter(q => set.has(q.id));
    }

    const lim = safeNum(state.settings.limitN, NaN);
    if(Number.isFinite(lim) && lim > 0) src = src.slice(0, lim);

    let ids = src.map(q => q.id);
    if(state.settings.shuffleQ) shuffle(ids);

    const map = {};
    for(const q of src){
      let opts = [
        { text: q.options.A, isCorrect: true },
        { text: q.options.B, isCorrect: false },
        { text: q.options.C, isCorrect: false },
        { text: q.options.D, isCorrect: false },
      ];
      if(state.settings.shuffleO) shuffle(opts);

      // ‚úÖ MODIFICA: pulisco il testo opzione dal prefisso A)/B)/...
      const mapped = opts.map((o,i) => ({
        label: LABELS[i],
        text: stripChoicePrefix(o.text),
        isCorrect: o.isCorrect
      }));

      const correctIndex = mapped.findIndex(o => o.isCorrect);
      map[q.id] = { question: q.question, options: mapped, correctIndex };
    }

    state.order = ids;
    state.map = map;
    state.answers = {};
    state.flagged = {};
    state.idx = 0;

    state.graded = false;
    state.wrongIds = [];
    state.correctIds = [];

    state.filter = "all";
    state.search = "";

    ensurePointsForIds(ids);

    if(state.settings.examMode){
      state.settings.instant = false;
      state.settings.showCorrectOnWrong = false;
    }

    state.timer = { startTs: null, running: false };

    save(true);
    updateTimerUI();
    startTimerIfNeeded(true);
    renderAll();
  }

  /* ---------------- Scoring ---------------- */
  function computeScore(){
    const s = state.settings.scoring || { correct: 1, wrong: 0, blank: 0 };
    const pWrong = safeNum(s.wrong, 0);
    const pBlank = safeNum(s.blank, 0);

    let score = 0;
    let max = 0;
    let ok = 0;
    let bad = 0;
    let blank = 0;

    for(const id of state.order){
      const q = state.map[id];
      const chosen = state.answers[id];
      const pCorrect = getPointsFor(id);
      max += pCorrect;

      if(chosen === undefined){
        blank++;
        score += pBlank;
        continue;
      }
      if(chosen === q.correctIndex){
        ok++;
        score += pCorrect;
      } else {
        bad++;
        score += pWrong;
      }
    }
    return { score, max, ok, bad, blank };
  }

  function scoreForUI(){
    if(state.settings.examMode && !state.graded){
      return { hidden: true, score: 0, max: 0, ok: 0, bad: 0, blank: 0 };
    }
    return { hidden: false, ...computeScore() };
  }

  /* ---------------- Timer ---------------- */
  function stopTimer(){
    if(timerHandle) clearInterval(timerHandle);
    timerHandle = null;
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function updateTimerUI(){
    $("timerPill").style.display = state.settings.useTimer ? "" : "none";
  }

  function startTimerIfNeeded(restart=false){
    stopTimer();
    if(!state.settings.useTimer){
      $("timerTxt").textContent = "00:00";
      state.timer = { startTs: null, running: false };
      save(true);
      return;
    }

    if(restart || !state.timer?.running || !state.timer?.startTs){
      state.timer = { startTs: Date.now(), running: true };
      save(true);
    }

    tickTimer();
    timerHandle = setInterval(tickTimer, 1000);
  }

  function tickTimer(){
    if(!state.settings.useTimer) return;
    if(!state.timer?.running || !state.timer?.startTs) return;

    const mins = safeNum(state.settings.timerMin, 30);
    const limitMs = mins * 60 * 1000;
    const elapsed = Date.now() - state.timer.startTs;
    const left = Math.max(0, limitMs - elapsed);

    const mm = Math.floor(left/60000);
    const ss = Math.floor((left%60000)/1000);
    $("timerTxt").textContent = `${pad2(mm)}:${pad2(ss)}`;

    if(left === 0){
      state.timer.running = false;
      save(true);
      gradeAll(true);
      stopTimer();
      alert("Tempo scaduto: quiz corretto.");
    }
  }

  /* ---------------- Grading ---------------- */
  function gradeAll(silent=false){
    const wrong = [];
    const correct = [];

    for(const id of state.order){
      const q = state.map[id];
      const chosen = state.answers[id];
      if(chosen !== undefined && chosen === q.correctIndex) correct.push(id);
      else wrong.push(id);
    }

    state.graded = true;
    state.wrongIds = wrong;
    state.correctIds = correct;

    $("repeatWrongBtn").style.display = wrong.length ? "" : "none";
    $("reportBtn").style.display = "" ;

    save(silent);
    renderAll();
    renderReport();
    toast("Corretto");
  }

  /* ---------------- Render ---------------- */
  function setChipOn(id, on){ $(id).classList.toggle("on", on); }

  function updateHeader(){
    const total = totalCount();
    const ans = answeredCount();
    const s = scoreForUI();

    $("navPill").textContent = `${ans}/${total}`;
    $("modePill").style.display = state.settings.examMode ? "" : "none";

    if(s.hidden){
      $("scorePill").textContent = "Punteggio: ‚Äî";
      $("scoreStat").textContent = "‚Äî";
      $("maxStat").textContent = "‚Äî";
      $("okStat").textContent = "‚Äî";
      $("badStat").textContent = "‚Äî";

      $("subStatus").textContent = state.graded
        ? `Corretto ‚Ä¢ Risposte: ${ans}/${total}`
        : `Modalit√† esame ‚Ä¢ Risposte: ${ans}/${total}`;
      return;
    }

    const pct = s.max ? Math.round((s.score/s.max)*100) : 0;

    $("scorePill").textContent = state.graded
      ? `‚úÖ ${s.score}/${s.max} (${pct}%)`
      : `‚è≥ ${s.score}/${s.max} (${pct}%)`;

    $("scoreStat").textContent = String(s.score);
    $("maxStat").textContent = String(s.max);
    $("okStat").textContent = String(s.ok);
    $("badStat").textContent = String(s.bad);

    $("subStatus").textContent = state.graded
      ? `Corretto ‚Ä¢ Punteggio ${s.score}/${s.max} (${pct}%)`
      : `In corso ‚Ä¢ Punteggio ${s.score}/${s.max} (${pct}%)`;
  }

  function renderMeta(){
    const id = currentId();
    const total = totalCount();

    const hasAns = state.answers[id] !== undefined;
    const flagged = !!state.flagged[id];

    const pills = [];
    pills.push(`<span class="pill">Domanda <strong>${state.idx+1}</strong> / ${total}</span>`);
    pills.push(hasAns ? `<span class="pill">Risposta data</span>` : `<span class="pill">Non risposta</span>`);
    if(flagged) pills.push(`<span class="pill warn">üö© Segnata</span>`);
    pills.push(`<span class="pill">ID: ${id}</span>`);
    if(state.settings.examMode) pills.push(`<span class="pill">Modalit√† esame</span>`);

    $("meta").innerHTML = pills.join(" ");

    $("pointsBox").style.display = state.settings.perQuestionPoints ? "" : "none";
    if(state.settings.perQuestionPoints){
      $("pointsInput").value = String(getPointsFor(id));
    }

    $("instantChk").checked = !!state.settings.instant;
    $("autoNextChk").checked = !!state.settings.autoNext;
  }

  function renderQuestion(){
    const id = currentId();
    const q = state.map[id];
    if(!q) return;

    renderMeta();
    $("qTitle").textContent = q.question;

    const chosen = state.answers[id];
    const optsEl = $("opts");
    optsEl.innerHTML = "";

    q.options.forEach((o, i) => {
      const lab = document.createElement("label");
      lab.className = "opt";
      lab.setAttribute("role","button");
      lab.setAttribute("tabindex","0");

      const inp = document.createElement("input");
      inp.type = "radio";
      inp.name = "q_" + id;
      inp.value = String(i);
      inp.checked = (chosen === i);

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = o.label;

      const text = document.createElement("div");
      // ‚úÖ MODIFICA: qui non metto pi√π "A) ..." nel testo (badge gi√† basta)
      text.textContent = o.text;

      function choose(){
        state.answers[id] = i;

        state.graded = false;
        state.wrongIds = [];
        state.correctIds = [];
        $("repeatWrongBtn").style.display = "none";
        $("reportBtn").style.display = "none";

        save(true);
        renderSide();
        highlightAnswer();
        updateHeader();
        updateJumpButtons();

        if(state.settings.autoNext){
          setTimeout(() => {
            if(state.idx < totalCount()-1){
              state.idx++;
              save(true);
              renderAll();
            }
          }, 520);
        }
      }

      inp.addEventListener("change", choose);
      lab.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          inp.checked = true;
          choose();
        }
      });

      lab.appendChild(inp);
      lab.appendChild(badge);
      lab.appendChild(text);
      optsEl.appendChild(lab);
    });

    $("prevBtn").disabled = state.idx === 0;
    $("nextBtn").disabled = state.idx === totalCount() - 1;
    $("flagBtn").textContent = state.flagged[id] ? "üö© Segnata" : "üö© Segna";

    highlightAnswer();
  }

  function highlightAnswer(){
    const id = currentId();
    const q = state.map[id];
    const chosen = state.answers[id];

    const rows = Array.from(document.querySelectorAll("#opts .opt"));
    rows.forEach(el => el.classList.remove("correct","wrong","warn"));
    $("feedback").textContent = "";

    if(state.graded){
      rows.forEach((el, idx) => {
        if(idx === q.correctIndex) el.classList.add("correct");
        if(chosen !== undefined && chosen !== q.correctIndex && idx === chosen) el.classList.add("wrong");
        if(chosen === undefined && idx === q.correctIndex) el.classList.add("warn");
      });
      const s = computeScore();
      const pct = s.max ? Math.round((s.score/s.max)*100) : 0;
      $("feedback").textContent = `Corretto. Punteggio: ${s.score}/${s.max} (${pct}%).`;
      return;
    }

    if(state.settings.examMode) return;
    if(!state.settings.instant) return;
    if(chosen === undefined) return;

    if(chosen === q.correctIndex){
      rows[chosen]?.classList.add("correct");
      $("feedback").textContent = "‚úÖ Corretta";
    } else {
      rows[chosen]?.classList.add("wrong");
      if(state.settings.showCorrectOnWrong){
        rows[q.correctIndex]?.classList.add("correct");
        $("feedback").textContent = "‚ùå Sbagliata (mostro anche la corretta)";
      } else {
        $("feedback").textContent = "‚ùå Sbagliata";
      }
    }
  }

  function passesFilter(id){
    const q = state.map[id];
    const chosen = state.answers[id];
    const flagged = !!state.flagged[id];

    if(state.search){
      const hay = (q.question || "").toLowerCase();
      if(!hay.includes(state.search.toLowerCase())) return false;
    }

    const isCorrect = state.graded && chosen !== undefined && chosen === q.correctIndex;
    const isWrong = state.graded && chosen !== undefined && chosen !== q.correctIndex;

    if(state.filter === "all") return true;
    if(state.filter === "unanswered") return chosen === undefined;
    if(state.filter === "flagged") return flagged;
    if(state.filter === "wrong") return state.graded && isWrong;
    if(state.filter === "correct") return state.graded && isCorrect;
    return true;
  }

  function renderSide(){
    setChipOn("chipAll", state.filter === "all");
    setChipOn("chipUnanswered", state.filter === "unanswered");
    setChipOn("chipFlagged", state.filter === "flagged");
    setChipOn("chipWrong", state.filter === "wrong");
    setChipOn("chipCorrect", state.filter === "correct");

    const nums = $("nums");
    nums.innerHTML = "";

    state.order.forEach((id, i) => {
      if(!passesFilter(id)) return;

      const q = state.map[id];
      const chosen = state.answers[id];

      const d = document.createElement("div");
      d.className = "num";
      d.textContent = String(i+1);

      if(i === state.idx) d.classList.add("cur");
      if(chosen !== undefined) d.classList.add("ans");
      if(state.flagged[id]) d.classList.add("flag");

      if(state.graded && chosen !== undefined){
        if(chosen === q.correctIndex) d.classList.add("ok");
        else d.classList.add("bad");
      }

      d.addEventListener("click", () => {
        state.idx = i;
        save(true);
        renderAll();
      });

      nums.appendChild(d);
    });
  }

  function updateJumpButtons(){
    const unanswered = state.order.some(id => state.answers[id] === undefined);
    $("jumpUnansweredBtn").style.display = unanswered ? "" : "none";
  }

  function renderAll(){
    renderQuestion();
    renderSide();
    updateJumpButtons();
    updateHeader();
  }

  /* ---------------- Report ---------------- */
  function renderReport(){
    if(!state.graded) return;

    const s = computeScore();
    const pct = s.max ? Math.round((s.score/s.max)*100) : 0;

    $("reportSummary").innerHTML = `
      <span class="pill ok">Corrette: <strong>${s.ok}</strong></span>
      <span class="pill bad">Sbagliate: <strong>${s.bad}</strong></span>
      <span class="pill">Non risposte: <strong>${s.blank}</strong></span>
      <span class="pill">Punteggio: <strong>${s.score}/${s.max}</strong> (${pct}%)</span>
    `;

    const list = $("wrongList");
    list.innerHTML = "";

    const wrongIds = [];
    state.order.forEach((id, idx) => {
      const q = state.map[id];
      const chosen = state.answers[id];
      if(chosen === undefined || chosen !== q.correctIndex){
        wrongIds.push(id);

        const item = document.createElement("div");
        item.className = "item";

        const chosenLabel = (chosen === undefined) ? "‚Äî" : q.options[chosen].label;
        const correctLabel = q.options[q.correctIndex].label;
        const pts = getPointsFor(id);

        item.innerHTML = `
          <div>
            <div><strong>#${idx+1}</strong> <small>(ID ${id})</small></div>
            <small>Scelta: ${chosenLabel} ‚Ä¢ Corretta: ${correctLabel} ‚Ä¢ Punti: ${pts}</small>
          </div>
        `;

        const btn = document.createElement("button");
        btn.textContent = "Vai";
        btn.addEventListener("click", () => {
          const i = state.order.indexOf(id);
          if(i >= 0){
            state.idx = i;
            save(true);
            $("dlgReport").close();
            renderAll();
          }
        });

        item.appendChild(btn);
        list.appendChild(item);
      }
    });

    state.wrongIds = wrongIds;
    $("repeatWrongBtn2").disabled = !wrongIds.length;
    save(true);
  }

  /* ---------------- Export ---------------- */
  function exportCSV(){
    const s = computeScore();
    const rows = [];
    rows.push(["num","id","question","chosen","correct","points_correct","points_awarded"].join(","));

    state.order.forEach((id, idx) => {
      const q = state.map[id];
      const chosenIdx = state.answers[id];
      const correctIdx = q.correctIndex;

      const chosen = (chosenIdx === undefined) ? "" : q.options[chosenIdx].label;
      const correct = q.options[correctIdx].label;

      const pCorrect = getPointsFor(id);
      const pWrong = safeNum(state.settings.scoring.wrong, 0);
      const pBlank = safeNum(state.settings.scoring.blank, 0);

      let awarded = pBlank;
      if(chosenIdx !== undefined){
        awarded = (chosenIdx === correctIdx) ? pCorrect : pWrong;
      }

      const question = (q.question || "").replaceAll('"','""');
      rows.push([ idx+1, id, `"${question}"`, chosen, correct, pCorrect, awarded ].join(","));
    });

    rows.push("");
    rows.push(`"SCORE",${s.score},"MAX",${s.max},"OK",${s.ok},"BAD",${s.bad},"BLANK",${s.blank}`);

    const csv = rows.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "risultati_tecniche_investigative.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /* ---------------- Events ---------------- */
  function setFilter(f){
    if((f === "wrong" || f === "correct") && !state.graded){
      alert("Prima premi ‚ÄúCorreggi‚Äù per filtrare corrette/sbagliate.");
      return;
    }
    state.filter = f;
    save(true);
    renderSide();
  }

  $("chipAll").addEventListener("click", () => setFilter("all"));
  $("chipUnanswered").addEventListener("click", () => setFilter("unanswered"));
  $("chipFlagged").addEventListener("click", () => setFilter("flagged"));
  $("chipWrong").addEventListener("click", () => setFilter("wrong"));
  $("chipCorrect").addEventListener("click", () => setFilter("correct"));

  $("searchBox").addEventListener("input", (e) => {
    state.search = e.target.value.trim();
    save(true);
    renderSide();
  });

  $("prevBtn").addEventListener("click", () => {
    if(state.idx > 0){ state.idx--; save(true); renderAll(); }
  });
  $("nextBtn").addEventListener("click", () => {
    if(state.idx < totalCount()-1){ state.idx++; save(true); renderAll(); }
  });

  $("flagBtn").addEventListener("click", () => {
    const id = currentId();
    state.flagged[id] = !state.flagged[id];
    save(true);
    renderAll();
  });

  $("jumpUnansweredBtn").addEventListener("click", () => {
    const i = state.order.findIndex(id => state.answers[id] === undefined);
    if(i >= 0){ state.idx = i; save(true); renderAll(); }
    else alert("Hai risposto a tutte.");
  });

  $("instantChk").addEventListener("change", (e) => {
    state.settings.instant = !!e.target.checked;
    if(state.settings.examMode) state.settings.instant = false;
    save(true);
    highlightAnswer();
  });

  $("autoNextChk").addEventListener("change", (e) => {
    state.settings.autoNext = !!e.target.checked;
    save(true);
  });

  $("pointsInput").addEventListener("change", () => {
    if(!state.settings.perQuestionPoints) return;
    const id = currentId();
    const v = safeNum($("pointsInput").value, NaN);
    if(!Number.isFinite(v) || v < 0) return;
    state.points[id] = v;
    save(true);
    updateHeader();
    toast("Punti domanda aggiornati");
  });

  $("newBtn").addEventListener("click", () => buildQuizFromSource());
  $("gradeBtn").addEventListener("click", () => gradeAll(true));

  $("reportBtn").addEventListener("click", () => {
    renderReport();
    $("dlgReport").showModal();
  });

  $("repeatWrongBtn").addEventListener("click", () => {
    if(!state.wrongIds?.length) return;
    buildQuizFromSource(state.wrongIds);
    $("feedback").textContent = "Modalit√†: ripeti solo le sbagliate.";
  });
  $("repeatWrongBtn2").addEventListener("click", () => {
    if(!state.wrongIds?.length) return;
    $("dlgReport").close();
    buildQuizFromSource(state.wrongIds);
    $("feedback").textContent = "Modalit√†: ripeti solo le sbagliate.";
  });

  $("exportBtn").addEventListener("click", exportCSV);

  $("resetBtn").addEventListener("click", () => {
    if(confirm("Vuoi cancellare il salvataggio e ricominciare?")){
      resetSaved();
      location.reload();
    }
  });

  /* ---------------- Settings Dialog ---------------- */
  const dlgS = $("dlgSettings");
  $("settingsBtn").addEventListener("click", () => {
    $("shuffleQ").checked = !!state.settings.shuffleQ;
    $("shuffleO").checked = !!state.settings.shuffleO;
    $("examMode").checked = !!state.settings.examMode;

    $("limitN").value = state.settings.limitN ?? "";
    $("useTimer").checked = !!state.settings.useTimer;
    $("timerMin").value = state.settings.timerMin ?? 30;

    $("instantSet").checked = !!state.settings.instant;
    $("showCorrectOnWrong").checked = !!state.settings.showCorrectOnWrong;
    $("autoNextSet").checked = !!state.settings.autoNext;

    $("ptCorrect").value = String(safeNum(state.settings.scoring.correct,1));
    $("ptWrong").value = String(safeNum(state.settings.scoring.wrong,0));
    $("ptBlank").value = String(safeNum(state.settings.scoring.blank,0));

    $("perQPoints").checked = !!state.settings.perQuestionPoints;

    dlgS.showModal();
  });
  $("closeSettings").addEventListener("click", () => dlgS.close());

  function applySettings(){
    state.settings.shuffleQ = $("shuffleQ").checked;
    state.settings.shuffleO = $("shuffleO").checked;
    state.settings.examMode = $("examMode").checked;

    const lim = $("limitN").value.trim();
    state.settings.limitN = lim ? Math.max(1, parseInt(lim,10)) : null;

    state.settings.useTimer = $("useTimer").checked;
    state.settings.timerMin = Math.max(1, parseInt($("timerMin").value || "30", 10));

    state.settings.instant = $("instantSet").checked;
    state.settings.showCorrectOnWrong = $("showCorrectOnWrong").checked;
    state.settings.autoNext = $("autoNextSet").checked;

    state.settings.scoring.correct = safeNum($("ptCorrect").value, 1);
    state.settings.scoring.wrong = safeNum($("ptWrong").value, 0);
    state.settings.scoring.blank = safeNum($("ptBlank").value, 0);

    state.settings.perQuestionPoints = $("perQPoints").checked;

    if(state.settings.examMode){
      state.settings.instant = false;
      state.settings.showCorrectOnWrong = false;
    }

    save(true);
    updateTimerUI();
    buildQuizFromSource();
  }

  $("applySettings").addEventListener("click", () => {
    dlgS.close();
    applySettings();
  });

  $("presetPractice").addEventListener("click", () => {
    state.settings.examMode = false;
    state.settings.useTimer = false;
    state.settings.limitN = null;
    state.settings.instant = true;
    state.settings.showCorrectOnWrong = true;
    state.settings.autoNext = false;
    state.settings.shuffleQ = true;
    state.settings.shuffleO = true;
    save(true);
    dlgS.close();
    buildQuizFromSource();
  });
  $("presetExam30").addEventListener("click", () => {
    state.settings.examMode = true;
    state.settings.useTimer = true;
    state.settings.timerMin = 30;
    state.settings.limitN = 30;
    state.settings.instant = false;
    state.settings.showCorrectOnWrong = false;
    state.settings.autoNext = false;
    state.settings.shuffleQ = true;
    state.settings.shuffleO = true;
    save(true);
    dlgS.close();
    buildQuizFromSource();
  });
  $("presetExam60").addEventListener("click", () => {
    state.settings.examMode = true;
    state.settings.useTimer = true;
    state.settings.timerMin = 60;
    state.settings.limitN = 60;
    state.settings.instant = false;
    state.settings.showCorrectOnWrong = false;
    state.settings.autoNext = false;
    state.settings.shuffleQ = true;
    state.settings.shuffleO = true;
    save(true);
    dlgS.close();
    buildQuizFromSource();
  });

  $("applyPointsAllBtn").addEventListener("click", () => {
    const def = safeNum($("ptCorrect").value, 1);
    ensurePointsForIds(state.order);
    for(const id of state.order) state.points[id] = def;
    save(true);
    toast("Punti applicati a tutte");
  });

  $("resetPointsBtn").addEventListener("click", () => {
    const def = safeNum($("ptCorrect").value, 1);
    ensurePointsForIds(state.order);
    for(const id of state.order) state.points[id] = def;
    save(true);
    toast("Punti ripristinati");
  });

  /* ---------------- Report Dialog ---------------- */
  const dlgR = $("dlgReport");
  $("closeReport").addEventListener("click", () => dlgR.close());

  /* ---------------- Theme ---------------- */
  function setTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem(THEME_KEY, t);
    $("themeBtn").textContent = (t === "light") ? "üåô" : "‚òÄÔ∏è";
  }
  $("themeBtn").addEventListener("click", () => {
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
  });

  /* ---------------- Keyboard ---------------- */
  document.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : "";
    if(tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT") return;

    if(e.key === "ArrowLeft"){ $("prevBtn").click(); }
    if(e.key === "ArrowRight"){ $("nextBtn").click(); }
    if(e.key === "Enter"){ $("nextBtn").click(); }

    if(e.key === "f" || e.key === "F"){ $("flagBtn").click(); }
    if(e.key === "g" || e.key === "G"){ $("gradeBtn").click(); }
    if(e.key === "n" || e.key === "N"){ $("newBtn").click(); }
    if(e.key === "s" || e.key === "S"){ $("settingsBtn").click(); }

    const k = e.key.toUpperCase();
    if(["A","B","C","D"].includes(k)){
      const idx = ["A","B","C","D"].indexOf(k);
      const input = document.querySelector(`#opts .opt:nth-child(${idx+1}) input`);
      if(input){
        input.checked = true;
        input.dispatchEvent(new Event("change", { bubbles: true }));
      }
    }
  });

  $("exportBtn").addEventListener("click", exportCSV);

  /* ---------------- Load questions.json ---------------- */
  async function loadQuestions(){
    const res = await fetch("./questions.json", { cache: "no-store" });
    if(!res.ok) throw new Error("Impossibile caricare questions.json");
    const data = await res.json();
    if(!Array.isArray(data) || !data.length) throw new Error("questions.json vuoto o non valido");
    return data;
  }

  /* ---------------- Boot ---------------- */
  (async () => {
    setTheme(localStorage.getItem(THEME_KEY) || "dark");

    try{
      SOURCE = await loadQuestions();
    }catch(err){
      $("subStatus").textContent = "Errore caricamento domande";
      $("feedback").textContent = "Non riesco a leggere ./questions.json. Assicurati che sia in docs/ insieme a index.html.";
      console.error(err);
      return;
    }

    const hasSaved = loadSaved();
    updateTimerUI();

    if(!hasSaved){
      state.version = APP_VERSION;
      state.settings.scoring = { correct: 1, wrong: 0, blank: 0 };
      state.settings.perQuestionPoints = true;
      state.settings.shuffleQ = true;
      state.settings.shuffleO = true;
      state.settings.examMode = false;
      state.settings.instant = true;
      state.settings.showCorrectOnWrong = true;
      state.settings.autoNext = false;
      buildQuizFromSource();
    }else{
      ensurePointsForIds(state.order);
      startTimerIfNeeded(false);
      renderAll();
    }

    $("subStatus").textContent = `Pronto ‚Ä¢ Domande disponibili: ${SOURCE.length}`;
  })();
})();
</script>
</body>
</html>
